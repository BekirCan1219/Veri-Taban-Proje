<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <title>Ödünç Al</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; margin: 30px; background:#050712; color:#f5f5ff; }
    .top { display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap: wrap; }
    .muted { color:#9ca3af; font-size:13px; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:16px; margin-top:16px; }
    .card { border:1px solid #1f2933; border-radius: 16px; padding: 14px; box-shadow: 0 8px 30px rgba(0,0,0,.35); background:linear-gradient(145deg,#0b1120,#020617); }
    input, select { padding:10px; width:100%; margin:6px 0; border:1px solid #1f2933; border-radius:10px; background:#020617; color:#e5e7eb; }
    input:focus, select:focus { outline:none; border-color:#38bdf8; box-shadow:0 0 0 1px #38bdf8; }
    button { padding:10px 12px; border:0; border-radius:10px; cursor:pointer; font-weight:600; }
    button.primary { background:#38bdf8; color:#020617; }
    button.primary:hover { background:#0ea5e9; }
    button.ghost { background:#020617; color:#e5e7eb; border:1px solid #1f2933; }
    button.ghost:hover { border-color:#4b5563; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap: wrap; }
    table { width:100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border-bottom: 1px solid #111827; padding: 8px; text-align:left; font-size: 14px; }
    th { color:#9ca3af; font-weight:600; }
    .badge { display:inline-block; padding:3px 8px; border-radius:999px; font-size:12px; background:#111827; }
    .ok { background:#065f46; color:#bbf7d0; }
    .warn { background:#78350f; color:#fed7aa; }
    .err { background:#7f1d1d; color:#fecaca; }
    .msg { padding:10px 12px; border-radius: 10px; margin-top:10px; display:none; }
    .msg.show { display:block; }
    .msg.ok { background:#064e3b; color:#bbf7d0; }
    .msg.warn { background:#78350f; color:#fed7aa; }
    .msg.err { background:#7f1d1d; color:#fecaca; }
    a { color:#38bdf8; text-decoration:none; }
    a:hover { text-decoration:underline; }
    .small { font-size:12px; }

    /* Sayfalama */
    .pager-wrap { display:flex; justify-content:space-between; align-items:center; margin-top:8px; gap:8px; flex-wrap:wrap; }
    .pager { display:flex; gap:6px; flex-wrap:wrap; justify-content:flex-end; }
    .pager button {
      padding:4px 9px;
      font-size:12px;
      border-radius:999px;
      border:1px solid #1f2933;
      background:#020617;
      color:#e5e7eb;
    }
    .pager button.active {
      background:#e5e7eb;
      color:#020617;
      border-color:#e5e7eb;
    }
    .pager button:disabled {
      opacity:.4;
      cursor:default;
    }

    @media (max-width: 900px){
      body{ margin:16px; }
      .grid{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div class="top">
    <div>
      <h2>Kitap Seçerek Ödünç Alma</h2>
      <div class="muted">Kitap seç → kaç gün ödünç alacağını yaz → “Ödünç Al”.</div>
    </div>
    <div class="row">
      <a href="/" class="muted">Ana sayfa</a>
      <a href="/books-page" class="muted">Kitaplar</a>
      <a href="/logout" class="muted">Çıkış</a>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <h3>Ödünç Al</h3>

      <label class="muted">Kitap</label>
      <select id="bookSelect"></select>

      <div class="row">
        <div style="flex:1;">
          <label class="muted">Gün sayısı</label>
          <input id="daysInput" type="number" min="1" max="60" value="14" />
        </div>
        <div style="flex:1;">
          <label class="muted">Arama</label>
          <input id="searchInput" type="text" placeholder="Başlık / Yazar / ISBN ara..." />
        </div>
      </div>

      <div class="row" style="margin-top:8px;">
        <button class="primary" id="borrowBtn">Ödünç Al</button>
        <button class="ghost" id="refreshBtn">Listeyi Yenile</button>
      </div>

      <div id="msgBox" class="msg"></div>

      <hr style="border:0; border-top:1px solid #111827; margin:14px 0;">

      <div class="muted small">
        İpucu: “Mevcut kopya” 0 ise ödünç alamazsın. Liste sayfalı; en alttan sayfalar arasında geçiş yapabilirsin.
      </div>
    </div>

    <div class="card">
      <div class="top" style="margin:0;">
        <h3 style="margin:0;">Kitaplar</h3>
        <span class="badge" id="countBadge">0</span>
      </div>

      <table>
        <thead>
          <tr>
            <th>Kitap</th>
            <th>Yazar</th>
            <th>Mevcut</th>
          </tr>
        </thead>
        <tbody id="booksTbody"></tbody>
      </table>

      <!-- sayfalama + info -->
      <div class="pager-wrap">
        <div class="muted small" id="booksInfo"></div>
        <div class="pager" id="booksPager"></div>
      </div>
    </div>
  </div>

  <div class="card" style="margin-top:16px;">
    <div class="top" style="margin:0;">
      <h3 style="margin:0;">Benim Ödünçlerim</h3>
      <button class="ghost" id="myRefreshBtn">Yenile</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>Kitap</th>
          <th>Alış</th>
          <th>Teslim Tarihi</th>
          <th>Durum</th>
          <th>İşlem</th>
        </tr>
      </thead>
      <tbody id="myBorrowsTbody"></tbody>
    </table>
  </div>

<script>
  const bookSelect = document.getElementById("bookSelect");
  const booksTbody = document.getElementById("booksTbody");
  const myBorrowsTbody = document.getElementById("myBorrowsTbody");
  const daysInput = document.getElementById("daysInput");
  const searchInput = document.getElementById("searchInput");
  const borrowBtn = document.getElementById("borrowBtn");
  const refreshBtn = document.getElementById("refreshBtn");
  const myRefreshBtn = document.getElementById("myRefreshBtn");
  const msgBox = document.getElementById("msgBox");
  const countBadge = document.getElementById("countBadge");
  const booksInfo = document.getElementById("booksInfo");
  const booksPager = document.getElementById("booksPager");

  let allBooks = [];
  let pageSize = 10;
  let currentPage = 1;

  function showMsg(text, type="ok") {
    msgBox.className = "msg show " + type;
    msgBox.textContent = text;
    clearTimeout(window.__msgTimer);
    window.__msgTimer = setTimeout(() => msgBox.classList.remove("show"), 4000);
  }

  async function apiGet(url) {
    const res = await fetch(url, { credentials: "include" });
    const data = await res.json().catch(() => ({}));
    return { res, data };
  }

  async function apiPost(url, payload) {
    const res = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "include",
      body: JSON.stringify(payload || {})
    });
    const data = await res.json().catch(() => ({}));
    return { res, data };
  }

  function escapeHtml(s) {
    return String(s || "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function getFilteredBooks() {
    const q = (searchInput.value || "").toLowerCase().trim();
    if (!q) return allBooks;
    return allBooks.filter(b => {
      const t = (b.title || "").toLowerCase();
      const a = (b.author || "").toLowerCase();
      const i = (b.isbn || "").toLowerCase();
      return t.includes(q) || a.includes(q) || i.includes(q);
    });
  }

  function renderBooks() {
    const filtered = getFilteredBooks();
    const total = filtered.length;
    const totalPages = Math.max(1, Math.ceil(total / pageSize));
    if (currentPage > totalPages) currentPage = totalPages;

    const startIndex = (currentPage - 1) * pageSize;
    const pageItems = filtered.slice(startIndex, startIndex + pageSize);

    booksTbody.innerHTML = "";
    bookSelect.innerHTML = "";
    countBadge.textContent = String(total);

    if (total === 0) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="3" class="muted">Kitap bulunamadı</td>`;
      booksTbody.appendChild(tr);
      booksInfo.textContent = "0 kayıt";
      booksPager.innerHTML = "";
      return;
    }

    // tablo
    for (const b of pageItems) {
      const tr = document.createElement("tr");
      const avail = Number(b.available_copies ?? 0);

      tr.innerHTML = `
        <td><b>${escapeHtml(b.title || "")}</b><div class="muted small">${escapeHtml(b.isbn || "")}</div></td>
        <td>${escapeHtml(b.author || "")}</td>
        <td>
          <span class="badge ${avail > 0 ? "ok" : "err"}">${avail} / ${Number(b.total_copies ?? 0)}</span>
        </td>
      `;
      booksTbody.appendChild(tr);
    }

    // select (her zaman tüm listeden, sayfadan bağımsız)
    for (const b of filtered) {
      const avail = Number(b.available_copies ?? 0);
      const opt = document.createElement("option");
      opt.value = b.id;
      opt.textContent = `${b.title} — ${b.author} (Mevcut: ${avail})`;
      opt.disabled = avail < 1;
      bookSelect.appendChild(opt);
    }

    // info
    booksInfo.textContent = `${total} kitap • Sayfa ${currentPage}/${totalPages}`;

    // pager
    booksPager.innerHTML = "";
    if (totalPages > 1) {
      const prevBtn = document.createElement("button");
      prevBtn.textContent = "‹";
      prevBtn.disabled = currentPage === 1;
      prevBtn.onclick = () => { if (currentPage > 1) { currentPage--; renderBooks(); } };
      booksPager.appendChild(prevBtn);

      for (let p = 1; p <= totalPages; p++) {
        const btn = document.createElement("button");
        btn.textContent = p;
        if (p === currentPage) btn.classList.add("active");
        btn.onclick = () => { currentPage = p; renderBooks(); };
        booksPager.appendChild(btn);
      }

      const nextBtn = document.createElement("button");
      nextBtn.textContent = "›";
      nextBtn.disabled = currentPage === totalPages;
      nextBtn.onclick = () => { if (currentPage < totalPages) { currentPage++; renderBooks(); } };
      booksPager.appendChild(nextBtn);
    }
  }

  async function loadBooks() {
    const { res, data } = await apiGet("/web/api/books");
    if (!res.ok || !data.success) {
      showMsg(data.message || "Kitaplar alınamadı", "err");
      return;
    }
    allBooks = data.data || [];
    currentPage = 1;
    renderBooks();
  }

  async function loadMyBorrows() {
    const { res, data } = await apiGet("/web/api/borrow/my");
    if (!res.ok || !data.success) {
      showMsg(data.message || "Ödünçler alınamadı", "err");
      return;
    }

    const rows = data.data || [];
    myBorrowsTbody.innerHTML = "";

    if (rows.length === 0) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="5" class="muted">Henüz ödünç kaydın yok</td>`;
      myBorrowsTbody.appendChild(tr);
      return;
    }

    for (const x of rows) {
      const isReturned = !!x.returned_at;
      const badgeClass = isReturned ? "ok" : (x.status === "overdue" ? "err" : "warn");

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><b>${escapeHtml(x.book_title || "")}</b><div class="muted small">#${x.id}</div></td>
        <td>${escapeHtml(x.borrowed_at || "")}</td>
        <td>${escapeHtml(x.due_date || "")}</td>
        <td><span class="badge ${badgeClass}">${escapeHtml(x.status || "")}</span></td>
        <td>
          ${isReturned
            ? `<span class="muted small">İade edildi</span>`
            : `<button class="ghost" data-return-id="${x.id}">İade Et</button>`
          }
        </td>
      `;
      myBorrowsTbody.appendChild(tr);
    }

    myBorrowsTbody.querySelectorAll("button[data-return-id]").forEach(btn => {
      btn.addEventListener("click", async () => {
        const id = btn.getAttribute("data-return-id");
        const { res, data } = await apiPost(`/web/api/borrow/return/${id}`, {});
        if (!res.ok || !data.success) {
          showMsg(data.message || "İade başarısız", "err");
          return;
        }
        showMsg("İade alındı ✅", "ok");
        await loadBooks();
        await loadMyBorrows();
      });
    });
  }

  borrowBtn.addEventListener("click", async () => {
    const bookId = Number(bookSelect.value);
    const days = Number(daysInput.value);

    if (!bookId) {
      showMsg("Önce bir kitap seç", "warn");
      return;
    }
    if (!days || days < 1 || days > 60) {
      showMsg("Gün sayısı 1-60 arası olmalı", "warn");
      return;
    }

    const { res, data } = await apiPost("/web/api/borrow", { book_id: bookId, days });
    if (!res.ok || !data.success) {
      showMsg(data.message || "Ödünç alma başarısız", "err");
      return;
    }

    showMsg(`Ödünç alındı ✅ Teslim: ${data.due_date}`, "ok");
    await loadBooks();
    await loadMyBorrows();
  });

  refreshBtn.addEventListener("click", async () => {
    await loadBooks();
    showMsg("Kitap listesi yenilendi", "ok");
  });

  myRefreshBtn.addEventListener("click", async () => {
    await loadMyBorrows();
    showMsg("Ödünçler yenilendi", "ok");
  });

  searchInput.addEventListener("input", () => {
    currentPage = 1;
    renderBooks();
  });

  // initial
  loadBooks();
  loadMyBorrows();
</script>
</body>
</html>
