<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin • Kütüphane</title>
  <style>
    :root{
      --bg:#070A12;
      --bg2:#0B1020;
      --card: rgba(255,255,255,.06);
      --text:#EAF0FF;
      --muted: rgba(234,240,255,.68);
      --line: rgba(255,255,255,.12);
      --accent:#6EE7FF;
      --accent2:#A78BFA;
      --good:#34D399;
      --bad:#FB7185;
      --warn:#FBBF24;
      --radius: 18px;
      --shadow: 0 18px 60px rgba(0,0,0,.45);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0; color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1000px 500px at 20% 10%, rgba(110,231,255,.14), transparent 60%),
        radial-gradient(900px 500px at 85% 15%, rgba(167,139,250,.14), transparent 55%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      min-height:100vh;
      padding: 22px;
    }
    .shell{ width:min(1250px,100%); margin:0 auto; }
    .nav{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:14px 16px;
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: rgba(255,255,255,.04);
      box-shadow: var(--shadow);
      position: sticky; top: 14px; z-index: 10;
      backdrop-filter: blur(12px);
    }
    .brand{ display:flex; align-items:center; gap:12px; }
    .logo{
      width:42px; height:42px; border-radius: 14px;
      background: linear-gradient(135deg, rgba(110,231,255,.35), rgba(167,139,250,.35));
      border:1px solid rgba(255,255,255,.16);
      display:grid; place-items:center;
    }
    .brand h1{ font-size: 16px; margin:0; }
    .brand .muted{ font-size:12px; margin-top:2px; }
    .navlinks{ display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; align-items:center; }
    .link{
      color: rgba(234,240,255,.9);
      text-decoration:none;
      font-size: 13px;
      padding:9px 10px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      transition:.15s ease;
    }
    .link:hover{ transform: translateY(-1px); border-color: rgba(110,231,255,.25); }
    .btn{
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(234,240,255,.92);
      cursor:pointer;
      transition:.15s ease;
      font-weight:600;
      white-space:nowrap;
    }
    .btn:hover{ transform: translateY(-1px); border-color: rgba(167,139,250,.28); }
    .btn.primary{
      border:0;
      background: linear-gradient(135deg, rgba(110,231,255,.95), rgba(167,139,250,.95));
      color:#071018;
      box-shadow: 0 14px 35px rgba(110,231,255,.18);
    }
    .btn.danger{
      border:1px solid rgba(251,113,133,.28);
      background: rgba(251,113,133,.10);
    }

    .kpis{ display:grid; grid-template-columns: repeat(4, 1fr); gap:14px; margin-top:16px; }
    .kpi{
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: rgba(255,255,255,.04);
      box-shadow: var(--shadow);
      padding: 14px;
      overflow:hidden;
      position:relative;
    }
    .kpi:before{
      content:""; position:absolute; inset:auto -80px -80px auto;
      width:200px; height:200px;
      background: radial-gradient(circle at 30% 30%, rgba(110,231,255,.22), transparent 60%),
                  radial-gradient(circle at 70% 70%, rgba(167,139,250,.22), transparent 60%);
      transform: rotate(14deg);
      pointer-events:none;
    }
    .kpi .t{ color: rgba(234,240,255,.70); font-size: 12px; text-transform:uppercase; letter-spacing:.12em; }
    .kpi .v{ margin-top:8px; font-size: 30px; font-weight: 800; letter-spacing:-.02em; }
    .kpi .s{ margin-top:6px; color: rgba(234,240,255,.62); font-size:12px; }

    .grid{ display:grid; grid-template-columns: 1fr 1.2fr; gap:16px; margin-top:16px; }
    .card{
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: rgba(255,255,255,.04);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardhd{
      padding:14px 14px 12px;
      display:flex; justify-content:space-between; align-items:flex-end; gap:12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background: linear-gradient(180deg, rgba(255,255,255,.04), transparent);
    }
    .cardhd h2{ margin:0; font-size: 16px; }
    .cardhd .muted{ font-size:12px; }
    .body{ padding: 14px; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .input{
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      outline:none;
      transition: .2s ease;
      width:100%;
    }
    .input:focus{
      border-color: rgba(110,231,255,.55);
      box-shadow: 0 0 0 5px rgba(110,231,255,.10);
    }
    .two{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    table{ width:100%; border-collapse: collapse; }
    th, td{ padding:12px 14px; border-bottom:1px solid rgba(255,255,255,.08); vertical-align:top; }
    th{ font-size:12px; color: rgba(234,240,255,.70); text-transform:uppercase; letter-spacing:.12em; }
    td{ font-size:14px; }
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      font-size: 12px;
      color: rgba(234,240,255,.88);
      white-space:nowrap;
    }
    .badge.ok{ border-color: rgba(52,211,153,.22); }
    .badge.warn{ border-color: rgba(251,191,36,.22); }
    .badge.err{ border-color: rgba(251,113,133,.22); }
    .mutedSmall{ color: rgba(234,240,255,.62); font-size: 12px; margin-top:4px; }
    .right{ text-align:right; }

    .toast{
      position: fixed; inset: 18px 18px auto auto;
      width:min(420px, calc(100vw - 36px));
      border-radius: 16px;
      padding: 12px 14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(12px);
      box-shadow: 0 20px 60px rgba(0,0,0,.45);
      display:none;
      z-index: 99;
    }
    .toast.show{ display:block; animation: pop .2s ease-out; }
    @keyframes pop{ from{ transform: translateY(-6px); opacity:.6;} to{ transform: translateY(0); opacity:1;} }
    .toast.ok{ border-color: rgba(52,211,153,.35); }
    .toast.err{ border-color: rgba(251,113,133,.35); }
    .toast b{ display:block; margin-bottom:2px; }
    .toast .small{ color: rgba(234,240,255,.66); font-size: 12px; }

    @media (max-width: 1050px){
      .kpis{ grid-template-columns: 1fr 1fr; }
      .grid{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div class="shell">
    <div class="nav">
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
            <path d="M6 4h11a2 2 0 0 1 2 2v13a1 1 0 0 1-1 1H7a2 2 0 0 1-2-2V4z" stroke="rgba(234,240,255,.92)" stroke-width="1.6"/>
            <path d="M8 7h8M8 10h8M8 13h6" stroke="rgba(234,240,255,.75)" stroke-width="1.6" stroke-linecap="round"/>
          </svg>
        </div>
        <div>
          <h1>Admin Panel</h1>
          <div class="muted">Kullanıcı: <b>{{ username }}</b> • Rol: <b>{{ role }}</b></div>
        </div>
      </div>

      <div class="navlinks">
        <button class="btn" onclick="refreshAll()">Yenile</button>
        <button class="btn primary" onclick="runLateCheck()">Gecikme Kontrolü</button>
        <a class="link" href="/books-page">Kitaplar</a>
        <a class="link" href="/borrow-page">Ödünç</a>
        <a class="link" href="/logout">Çıkış</a>
      </div>
    </div>

    <div class="kpis">
      <div class="kpi">
        <div class="t">Toplam Kitap</div>
        <div class="v" id="s_total_books">—</div>
        <div class="s">Katalog çeşitliliği</div>
      </div>
      <div class="kpi">
        <div class="t">Toplam Kopya</div>
        <div class="v" id="s_total_copies">—</div>
        <div class="s">Stok kapasitesi</div>
      </div>
      <div class="kpi">
        <div class="t">Aktif Ödünç</div>
        <div class="v" id="s_active">—</div>
        <div class="s">Şu an dışarıda</div>
      </div>
      <div class="kpi">
        <div class="t">Geciken</div>
        <div class="v" id="s_overdue">—</div>
        <div class="s">Aksiyon gerekli</div>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <div class="cardhd">
          <div>
            <h2>Yeni Kitap</h2>
            <div class="muted">Hızlı ekle • stok ayarla</div>
          </div>
          <div class="row">
            <button class="btn" onclick="clearCreate()">Temizle</button>
            <button class="btn primary" onclick="createBook()">Kaydet</button>
          </div>
        </div>

        <div class="body">
          <div class="two">
            <div>
              <div class="muted" style="font-size:12px;">Başlık</div>
              <input class="input" id="c_title" placeholder="Örn: Design Patterns" />
            </div>
            <div>
              <div class="muted" style="font-size:12px;">Yazar</div>
              <input class="input" id="c_author" placeholder="Örn: GoF" />
            </div>
          </div>

          <div style="margin-top:10px;">
            <div class="muted" style="font-size:12px;">ISBN (opsiyonel)</div>
            <input class="input" id="c_isbn" placeholder="978-..." />
          </div>

          <div class="two" style="margin-top:10px;">
            <div>
              <div class="muted" style="font-size:12px;">Toplam</div>
              <input class="input" id="c_total" type="number" min="1" value="1" />
            </div>
            <div>
              <div class="muted" style="font-size:12px;">Mevcut</div>
              <input class="input" id="c_avail" type="number" min="0" value="1" />
            </div>
          </div>

          <div id="createMsg" class="mutedSmall"></div>

          <hr style="border:none; border-top:1px solid rgba(255,255,255,.10); margin:14px 0;">

          <div class="cardhd" style="padding:0; border:0; background:none;">
            <div>
              <h2 style="font-size:16px; margin:0;">Geciken Ödünçler</h2>
              <div class="muted">Due date geçmiş, iade edilmemiş</div>
            </div>
            <button class="btn" onclick="loadOverdue()">Yenile</button>
          </div>

          <div style="overflow:auto; margin-top:10px;">
            <table>
              <thead>
                <tr>
                  <th style="width:70px;">ID</th>
                  <th>Kullanıcı</th>
                  <th>Kitap</th>
                  <th class="right" style="width:190px;">Due</th>
                </tr>
              </thead>
              <tbody id="overdueTbody"></tbody>
            </table>
          </div>
          <div id="overdueMsg" class="mutedSmall"></div>

          <hr style="border:none; border-top:1px solid rgba(255,255,255,.10); margin:14px 0;">

          <div class="cardhd" style="padding:0; border:0; background:none;">
            <div>
              <h2 style="font-size:16px; margin:0;">Mail Gönderim Raporu</h2>
              <div class="muted">Gönderilen e-postaların kayıtları</div>
            </div>
            <button class="btn" onclick="loadMailReport()">Yenile</button>
          </div>

          <div style="overflow:auto; margin-top:10px;">
            <table>
              <thead>
                <tr>
                  <th style="width:70px;">ID</th>
                  <th>Kullanıcı</th>
                  <th>Email</th>
                  <th>Kitap</th>
                  <th class="right" style="width:190px;">Due</th>
                  <th class="right" style="width:190px;">Gönderim</th>
                </tr>
              </thead>
              <tbody id="mailReportTbody"></tbody>
            </table>
          </div>
          <div id="mailReportMsg" class="mutedSmall"></div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <div class="cardhd">
          <div>
            <h2>Kitap Yönetimi</h2>
            <div class="muted">Düzenle • sil • filtrele</div>
          </div>
          <div class="row" style="min-width:280px;">
            <input class="input" id="search" placeholder="Ara: başlık / yazar" oninput="renderFiltered()" />
          </div>
        </div>

        <div style="overflow:auto;">
          <table>
            <thead>
              <tr>
                <th style="width:70px;">ID</th>
                <th>Kitap</th>
                <th style="width:190px;">Yazar</th>
                <th class="right" style="width:140px;">Mevcut</th>
                <th style="width:190px;">İşlem</th>
              </tr>
            </thead>
            <tbody id="booksTbody"></tbody>
          </table>
        </div>

        <div class="body">
          <div class="row" style="justify-content:space-between;">
            <div>
              <h2 style="font-size:16px; margin:0;">Düzenle</h2>
              <div class="muted">Seçili Kitap ID: <b id="e_id">—</b></div>
            </div>
            <div class="row">
              <button class="btn" onclick="clearEdit()">Temizle</button>
              <button class="btn primary" onclick="updateBook()">Kaydet</button>
            </div>
          </div>

          <div class="two" style="margin-top:10px;">
            <div>
              <div class="muted" style="font-size:12px;">Başlık</div>
              <input class="input" id="e_title" placeholder="Başlık" />
            </div>
            <div>
              <div class="muted" style="font-size:12px;">Yazar</div>
              <input class="input" id="e_author" placeholder="Yazar" />
            </div>
          </div>

          <div style="margin-top:10px;">
            <div class="muted" style="font-size:12px;">ISBN (opsiyonel)</div>
            <input class="input" id="e_isbn" placeholder="ISBN" />
          </div>

          <div class="two" style="margin-top:10px;">
            <div>
              <div class="muted" style="font-size:12px;">Toplam</div>
              <input class="input" id="e_total" type="number" min="1" />
            </div>
            <div>
              <div class="muted" style="font-size:12px;">Mevcut</div>
              <input class="input" id="e_avail" type="number" min="0" />
            </div>
          </div>

          <div id="editMsg" class="mutedSmall"></div>

          <hr style="border:none; border-top:1px solid rgba(255,255,255,.10); margin:14px 0;">

          <div class="cardhd" style="padding:0; border:0; background:none;">
            <div>
              <h2 style="font-size:16px; margin:0;">Bildirimler</h2>
              <div class="muted">Geciken veya teslim tarihi yaklaşan kayıtlar</div>
            </div>
            <button class="btn" onclick="loadNotifications()">Yenile</button>
          </div>

          <div style="overflow:auto; margin-top:10px;">
            <table>
              <thead>
                <tr>
                  <th style="width:110px;">Tip</th>
                  <th>Mesaj</th>
                  <th style="width:220px;">Kitap / Kullanıcı</th>
                  <th class="right" style="width:190px;">Due</th>
                </tr>
              </thead>
              <tbody id="notifTbody"></tbody>
            </table>
          </div>
          <div id="notifMsg" class="mutedSmall"></div>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast">
    <b id="toastTitle">Bildirim</b>
    <div id="toastBody" class="small"></div>
  </div>

  <script>
    let selectedBookId = null;
    let allBooks = [];

    function toast(msg, ok=true, title=null){
      const t = document.getElementById("toast");
      document.getElementById("toastTitle").textContent = title || (ok ? "Başarılı" : "Hata");
      document.getElementById("toastBody").textContent = msg || "";
      t.className = "toast show " + (ok ? "ok" : "err");
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(()=> t.classList.remove("show"), 3200);
    }

    function setText(id, v){ const el = document.getElementById(id); if(el) el.textContent = v; }

    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function clearCreate(){
      document.getElementById("c_title").value = "";
      document.getElementById("c_author").value = "";
      document.getElementById("c_isbn").value = "";
      document.getElementById("c_total").value = "1";
      document.getElementById("c_avail").value = "1";
      setText("createMsg", "");
    }

    function clearEdit(){
      selectedBookId = null;
      setText("e_id", "—");
      document.getElementById("e_title").value = "";
      document.getElementById("e_author").value = "";
      document.getElementById("e_isbn").value = "";
      document.getElementById("e_total").value = "";
      document.getElementById("e_avail").value = "";
      setText("editMsg", "");
    }

    async function refreshAll(){
      await loadStats();
      await loadBooks();
      await loadOverdue();
      await loadNotifications();
      await loadMailReport();
    }

    async function loadStats(){
      try{
        const res = await fetch("/web/api/admin/stats", { credentials:"include" });
        const j = await res.json();
        if(!res.ok || j.success === false) return;
        setText("s_total_books", j.data.total_books);
        setText("s_total_copies", j.data.total_copies);
        setText("s_active", j.data.active_borrows);
        setText("s_overdue", j.data.overdue_borrows);
      }catch(e){}
    }

    async function loadBooks(){
      const res = await fetch("/web/api/books", { credentials:"include" });
      const data = await res.json().catch(()=>({}));
      allBooks = data.data || [];
      renderFiltered();
    }

    function renderFiltered(){
      const q = (document.getElementById("search").value || "").trim().toLowerCase();
      const list = !q ? allBooks : allBooks.filter(b =>
        String(b.title||"").toLowerCase().includes(q) ||
        String(b.author||"").toLowerCase().includes(q)
      );

      const tbody = document.getElementById("booksTbody");
      tbody.innerHTML = "";

      if(!list.length){
        tbody.innerHTML = `<tr><td colspan="5" style="color:rgba(234,240,255,.65); padding:16px;">Sonuç yok.</td></tr>`;
        return;
      }

      list.forEach(b => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${b.id}</td>
          <td>
            <b>${escapeHtml(b.title)}</b>
            <div class="mutedSmall">${escapeHtml(b.isbn || "")}</div>
          </td>
          <td>${escapeHtml(b.author)}</td>
          <td class="right"><span class="badge ${Number(b.available_copies)>0 ? "ok":"err"}">${b.available_copies}/${b.total_copies}</span></td>
          <td>
            <button class="btn" type="button" onclick='selectBook(${JSON.stringify(b)})'>Düzenle</button>
            <button class="btn danger" type="button" onclick='deleteBook(${b.id})'>Sil</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function selectBook(b){
      selectedBookId = b.id;
      setText("e_id", b.id);
      document.getElementById("e_title").value = b.title || "";
      document.getElementById("e_author").value = b.author || "";
      document.getElementById("e_isbn").value = b.isbn || "";
      document.getElementById("e_total").value = b.total_copies;
      document.getElementById("e_avail").value = b.available_copies;
      setText("editMsg", "Form dolduruldu. Değiştirip Kaydet’e bas.");
    }

    async function createBook(){
      const payload = {
        title: (document.getElementById("c_title").value || "").trim(),
        author: (document.getElementById("c_author").value || "").trim(),
        isbn: (document.getElementById("c_isbn").value || "").trim() || null,
        total_copies: parseInt(document.getElementById("c_total").value || "1"),
        available_copies: parseInt(document.getElementById("c_avail").value || "1")
      };
      if(!payload.title || !payload.author){
        return toast("Başlık ve yazar zorunlu.", false);
      }

      setText("createMsg","Kaydediliyor…");

      const res = await fetch("/web/api/books", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        credentials:"include",
        body: JSON.stringify(payload)
      });
      const data = await res.json().catch(()=>({}));

      if(!res.ok || data.success === false){
        setText("createMsg","");
        return toast(data.message || "Ekleme başarısız", false);
      }

      toast(`Kitap eklendi (id=${data.id})`, true);
      clearCreate();
      await refreshAll();
    }

    async function updateBook(){
      if(!selectedBookId) return toast("Önce bir kitap seç (Düzenle).", false);

      const payload = {
        title: (document.getElementById("e_title").value || "").trim(),
        author: (document.getElementById("e_author").value || "").trim(),
        isbn: (document.getElementById("e_isbn").value || "").trim() || null,
        total_copies: parseInt(document.getElementById("e_total").value || "1"),
        available_copies: parseInt(document.getElementById("e_avail").value || "0")
      };
      if(!payload.title || !payload.author) return toast("Başlık ve yazar zorunlu.", false);

      setText("editMsg","Güncelleniyor…");

      const res = await fetch(`/web/api/books/${selectedBookId}`, {
        method:"PUT",
        headers:{ "Content-Type":"application/json" },
        credentials:"include",
        body: JSON.stringify(payload)
      });
      const data = await res.json().catch(()=>({}));

      if(!res.ok || data.success === false){
        setText("editMsg","");
        return toast(data.message || "Güncelleme başarısız", false);
      }

      toast("Güncelleme başarılı ✅", true);
      await refreshAll();
    }

    async function deleteBook(id){
      if(!confirm(`Kitap silinsin mi? (id=${id})`)) return;
      const res = await fetch(`/web/api/books/${id}`, { method:"DELETE", credentials:"include" });
      const data = await res.json().catch(()=>({}));
      if(!res.ok || data.success === false){
        return toast(data.message || "Silme hatası", false);
      }
      if(selectedBookId === id) clearEdit();
      toast("Silindi.", true);
      await refreshAll();
    }

    async function loadOverdue(){
      setText("overdueMsg","Yükleniyor…");
      try{
        const res = await fetch("/web/api/admin/overdue", { credentials:"include" });
        const data = await res.json().catch(()=>({}));
        const tb = document.getElementById("overdueTbody");
        tb.innerHTML = "";

        const rows = data.data || [];
        if(!rows.length){
          tb.innerHTML = `<tr><td colspan="4" style="color:rgba(234,240,255,.65); padding:16px;">Geciken kayıt yok.</td></tr>`;
          setText("overdueMsg","0 kayıt");
          return;
        }

        rows.forEach(x=>{
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${x.id}</td>
            <td><b>${escapeHtml(x.user||"-")}</b><div class="mutedSmall">${escapeHtml(x.email||"")}</div></td>
            <td>${escapeHtml(x.book||"-")}</td>
            <td class="right">${escapeHtml(x.due_date||"-")}</td>
          `;
          tb.appendChild(tr);
        });
        setText("overdueMsg", `Geciken kayıt: ${rows.length}`);
      }catch(e){
        setText("overdueMsg","Yüklenemedi.");
      }
    }

    async function loadNotifications(){
      setText("notifMsg","Yükleniyor…");
      try{
        const res = await fetch("/web/api/admin/notifications", { credentials:"include" });
        const data = await res.json().catch(()=>({}));
        const tb = document.getElementById("notifTbody");
        tb.innerHTML = "";

        const rows = data.data || [];
        if(!rows.length){
          tb.innerHTML = `<tr><td colspan="4" style="color:rgba(234,240,255,.65); padding:16px;">Bildirim yok.</td></tr>`;
          setText("notifMsg","0 kayıt");
          return;
        }

        rows.forEach(x=>{
          const type = x.type || "-";
          const cls = type === "overdue" ? "err" : (type === "due_soon" ? "warn" : "ok");
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td><span class="badge ${cls}">${escapeHtml(type)}</span></td>
            <td>${escapeHtml(x.message||"-")}</td>
            <td>${escapeHtml(x.book||"-")}<div class="mutedSmall">${escapeHtml(x.user||"")} ${x.email ? " • " + escapeHtml(x.email) : ""}</div></td>
            <td class="right">${escapeHtml(x.due_date||"-")}</td>
          `;
          tb.appendChild(tr);
        });
        setText("notifMsg", `Bildirim: ${rows.length}`);
      }catch(e){
        setText("notifMsg","Yüklenemedi.");
      }
    }

    async function loadMailReport(){
      setText("mailReportMsg","Yükleniyor…");
      const tb = document.getElementById("mailReportTbody");
      tb.innerHTML = "";
      try{
        const res = await fetch("/web/api/admin/mail-report", { credentials:"include" });
        const data = await res.json().catch(()=>({}));
        const rows = data.data || [];

        if(!rows.length){
          tb.innerHTML = `<tr><td colspan="6" style="color:rgba(234,240,255,.65); padding:16px;">Mail kaydı yok (endpoint yoksa da bu normal).</td></tr>`;
          setText("mailReportMsg","0 kayıt");
          return;
        }

        rows.forEach(x=>{
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${x.id ?? "-"}</td>
            <td>${escapeHtml(x.user||"-")}</td>
            <td>${escapeHtml(x.email||"-")}</td>
            <td>${escapeHtml(x.book||"-")}</td>
            <td class="right">${escapeHtml(x.due_date||"-")}</td>
            <td class="right">${escapeHtml(x.sent_at||"-")}</td>
          `;
          tb.appendChild(tr);
        });
        setText("mailReportMsg", `Mail kaydı: ${rows.length}`);
      }catch(e){
        tb.innerHTML = `<tr><td colspan="6" style="color:rgba(234,240,255,.65); padding:16px;">Mail report endpoint’i yoksa bu alan boş kalır.</td></tr>`;
        setText("mailReportMsg","Endpoint yok / hata");
      }
    }

    async function runLateCheck(){
      toast("Gecikme kontrolü çalışıyor…", true, "İşleniyor");
      try{
        const res = await fetch("/web/api/admin/run-late-check", { method:"POST", credentials:"include" });
        const data = await res.json().catch(()=>({}));
        if(!res.ok || data.success === false){
          return toast(data.message || "Çalıştırılamadı", false);
        }
        toast("Kontrol tamamlandı ✅", true);
        await refreshAll();
      }catch(e){
        toast("İstek hatası: " + e, false);
      }
    }

    refreshAll();
  </script>
</body>
</html>
